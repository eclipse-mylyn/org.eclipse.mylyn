<!--
    Copyright (c) 2009 Tasktop Technologies and others.
    All rights reserved. This program and the accompanying materials
    are made available under the terms of the Eclipse Public License v1.0
    which accompanies this distribution, and is available at
    http://www.eclipse.org/legal/epl-v10.html
   
    Contributors:
         Tasktop Technologies - initial API and implementation
 -->
<project name="Build specific targets and properties" default="noDefault">

	<import file="orbitHelper.xml" />

	<!-- ===================================================================== -->
	<!-- Run a given ${target} on all elements being built -->
	<!-- Add on <ant> task for each top level element being built. -->
	<!-- ===================================================================== -->
	<property name="allElementsFile" value="${builder}/../allElements.xml" />
	<import file="${allElementsFile}" />
	<target name="allElements">
		<antcall target="allElementsDelegator" />
	</target>
	<target name="standardElements">
		<antcall target="standardDelegator" />
	</target>
	<target name="incubatorElements">
		<antcall target="incubatorDelegator" />
	</target>

	<!-- ===================================================================== -->
	<!-- ===================================================================== -->
	<target name="getBaseComponents" depends="checkLocalBase" unless="skipBase">
		<get src="${eclipseBaseURL}" dest="${buildDirectory}/../temp-base.zip" />
		<unzip dest="${base}" overwrite="true" src="${buildDirectory}/../temp-base.zip" />
	</target>

	<target name="checkLocalBase">
		<available file="${base}" property="skipBase" />
	</target>

	<!-- ===================================================================== -->
	<!-- Check out map files from correct repository -->
	<!-- Replace values for mapsCheckoutTag as desired. -->
	<!-- ===================================================================== -->
	<target name="getMapFiles" depends="checkLocalMaps" unless="skipMaps">
		<cvs cvsRoot="${mapsRepo}" package="${mapsRoot}" dest="${buildDirectory}/maps" tag="${mylynQualifier}" />
		<delete failonerror="false">
			<fileset dir="${buildDirectory}/maps" includes="**/mylyn*.map">
				<exclude name="**/*${baseTarget}.map"/>
				<exclude name="**/*all.map"/>
				<exclude name="**/*common.map"/>
			</fileset>
		</delete>
	</target>

	<target name="checkLocalMaps">
		<available property="skipMaps" file="${buildDirectory}/maps" />
	</target>

	<target name="tagMapFiles" if="tagMaps">
		<cvs dest="${buildDirectory}/maps/${mapsRoot}" command="tag ${mapsTagTag}" />
	</target>

	<!-- ===================================================================== -->

	<target name="clean" unless="noclean">
		<antcall target="allElements">
			<param name="target" value="cleanElement" />
		</antcall>
	</target>

	<target name="gatherLogs">
		<mkdir dir="${buildDirectory}/${buildLabel}/compilelogs" />
		<antcall target="allElements">
			<param name="target" value="gatherLogs" />
		</antcall>
		<unzip dest="${buildDirectory}/${buildLabel}/compilelogs" overwrite="true">
			<fileset dir="${buildDirectory}/features">
				<include name="**/*.log.zip" />
			</fileset>
		</unzip>
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before setup -->
	<!-- ===================================================================== -->
	<target name="preSetup">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after setup but before starting the build proper -->
	<!-- ===================================================================== -->
	<target name="postSetup" if="localBuild">
		<antcall target="getBaseComponents" />
		<copy todir="${buildDirectory}/plugins" overwrite="true">
			<fileset dir="${builder}/../../../">
				<include name="org.eclipse.mylyn*/**"/>
				<include name="sandbox/org.eclipse.mylyn*/**"/>
				<exclude name="org.eclipse.mylyn-site/**"/>
				<exclude name="org.eclipse.mylyn.releng/**"/>
				<exclude name="*-feature/**"/>
				<exclude name="sandbox/*-feature/**"/>
				<exclude name="**/.svn/**"/>
				<exclude name="**/bin/**"/>
			</fileset>
		</copy>
		<copy todir="${buildDirectory}/features" overwrite="true">
			<fileset dir="${builder}/../../../">
				<include name="org.eclipse.mylyn**-feature/**"/>
				<include name="sandbox/org.eclipse.mylyn**-feature/**"/>
				<exclude name="**/.svn/**"/>
				<exclude name="**/bin/**"/>
			</fileset>
		</copy>
		<map dir="${buildDirectory}/plugins" from="org.eclipse.mylyn.cdt(.*)" to="org.eclipse.cdt.mylyn\1"/>
		<map dir="${buildDirectory}/plugins" from="^sandbox/(.*)" to="\1"/>
		<map dir="${buildDirectory}/features" from="org.eclipse.mylyn.builds-feature(.*)" to="org.eclipse.mylyn.builds\1"/>
		<map dir="${buildDirectory}/features" from="org.eclipse.mylyn.cdt-feature(.*)" to="org.eclipse.cdt.mylyn\1"/>
		<map dir="${buildDirectory}/features" from="org.eclipse.mylyn.commons-feature(.*)" to="org.eclipse.mylyn.commons\1"/>
		<map dir="${buildDirectory}/features" from="org.eclipse.mylyn.hudson-feature(.*)" to="org.eclipse.mylyn.hudson\1"/>
		<map dir="${buildDirectory}/features" from="org.eclipse.mylyn.wikitext.(.*)-feature(.*)" to="org.eclipse.mylyn.wikitext.\1\2"/>
		<map dir="${buildDirectory}/features" from="(.*)-sdk-feature(.*)" to="\1_sdk_feature\2"/>
		<map dir="${buildDirectory}/features" from="(.*)-feature(.*)" to="\1_feature\2"/>
		<map dir="${buildDirectory}/features" from="^sandbox/(.*)" to="\1"/>
		<touch>
		  <fileset dir="${buildDirectory}/plugins" includes="org.eclipse.mylyn.discovery.ui/lib*/**/*"/>
		</touch>
		<antcall target="extract-dependencies"/>
	</target>

	<target name="extract-dependencies" if="build.dependencies">
	  <delete failonerror="false">
	    <fileset dir="${buildDirectory}/plugins" includes="*.jar"/>
	  </delete>
	  <unzip src="${build.dependencies}" dest="${buildDirectory}"/>
	</target>

	<macrodef name="map">
		<attribute name="dir"/>
		<attribute name="from"/>
		<attribute name="to"/>
		<sequential>			
			<move todir="@{dir}">
				<fileset dir="@{dir}" includes="*/**"/>
				<regexpmapper from="@{from}" to="@{to}"/>
			</move>
		</sequential>
	</macrodef>
	
	<!-- ===================================================================== -->
	<!-- Steps to do before fetching the build elements -->
	<!-- ===================================================================== -->
	<target name="preFetch">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after fetching the build elements -->
	<!-- ===================================================================== -->
	<target name="postFetch">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before generating the build scripts. -->
	<!-- ===================================================================== -->
	<target name="preGenerate">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after generating the build scripts. -->
	<!-- ===================================================================== -->
	<target name="postGenerate">
		<antcall target="clean" />
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before running the build.xmls for the elements being built. -->
	<!-- ===================================================================== -->
	<target name="preProcess">
		<replace dir="${buildDirectory}/features" value="${majorVersion}.${fullQualifier}" token="${majorVersion}.qualifier">
			<include name="**/feature.xml" />
		</replace>
		<replace dir="${buildDirectory}/features" value="${majorVersion}.${mylynQualifier}" token="${majorVersion}.mylynQualifier">
			<include name="**/feature.xml" />
		</replace>
		<available property="performance.tests.exist" file="${buildDirectory}/plugins/org.eclipse.test.performance"/>
		<antcall target="patch-performance-tests"/>
	</target>

	<target name="patch-performance-tests" if="performance.tests.exist">
		<patch patchfile="${builder}/../org.eclipse.test.performance.diff"
			dir="${buildDirectory}/plugins/org.eclipse.test.performance" strip="0"/>
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after running the build.xmls for the elements being built. -->
	<!-- ===================================================================== -->
	<target name="postProcess">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before running assemble. -->
	<!-- ===================================================================== -->
	<target name="preAssemble">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after  running assemble. -->
	<!-- ===================================================================== -->
	<target name="postAssemble">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before running package. -->
	<!-- ===================================================================== -->
	<target name="prePackage">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after  running package. -->
	<!-- ===================================================================== -->
	<target name="postPackage">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after the build is done. -->
	<!-- ===================================================================== -->
	<target name="postBuild" unless="localBuild">
		<antcall target="gatherLogs" />
		<antcall target="orbit-copy-bundles-helper" />
		<!--
		<exec executable="${builder}/../../copy-orbit-bundles.sh" failonerror="true">
			<arg value="${buildDirectory}" />
		</exec>
		<exec executable="${builder}/../../fix-build-files.sh" failonerror="true">
			<arg value="${buildDirectory}" />
		</exec>
		-->
		<antcall target="generateUpdateSite">
			<param name="UpdateSiteLocation" value="${buildDirectory}/standardUpdateSite" />
			<param name="SiteXmlFile" value="standard-site.xml" />
			<param name="ElementsTarget" value="standardElements" />
			<param name="SiteName" value="standard" />
			<param name="CategoriesXmlFile" value="../standard-categories.xml" />
		</antcall>
		<antcall target="generateUpdateSite">
			<param name="UpdateSiteLocation" value="${buildDirectory}/incubatorUpdateSite" />
			<param name="SiteXmlFile" value="../incubator-site.xml" />
			<param name="ElementsTarget" value="incubatorElements" />
			<param name="SiteName" value="incubator" />
		</antcall>
		<antcall target="generateUpdateSite">
			<param name="UpdateSiteLocation" value="${buildDirectory}/allUpdateSite" />
			<param name="SiteXmlFile" value="../all-site.xml" />
			<param name="ElementsTarget" value="allElements" />
			<param name="SiteName" value="all" />
		</antcall>
		<ant antfile="${builder}/../wikitext-standalone.xml">
			<property name="wikitext.standalone.archive" value="${buildDirectory}/standardUpdateSite/../mylyn-wikitext-standalone-${majorVersion}.${mylynQualifier}.zip"/>
			<property name="wikitext.standalone.dir" value="mylyn-wikitext-standalone-${majorVersion}.${mylynQualifier}"/>
			<property name="wikitext.plugin.jars.location" value="${buildDirectory}/standardUpdateSite/plugins"/>
			<property name="buildDirectory" value="${buildDirectory}"/>
			<property name="wikitext.version" value="${majorVersion}.${mylynQualifier}"/>
		</ant>
	</target>

	<target name="generateUpdateSite">
		<property file="${buildDirectory}/finalFeaturesVersions.properties" />
		<!-- Create the directory structure -->
		<mkdir dir="${UpdateSiteLocation}" />
		<mkdir dir="${UpdateSiteLocation}/features" />
		<mkdir dir="${UpdateSiteLocation}/plugins" />

		<!-- Generate the "site.xml" file in the "updateSite folder -->
		<copy file="${builder}/${SiteXmlFile}" tofile="${UpdateSiteLocation}/site.xml">
			<filterset>
				<filtersfile file="${buildDirectory}/finalFeaturesVersions.properties"/>
			</filterset>
		</copy>
		<copy file="${builder}/${SiteXmlFile}" tofile="${UpdateSiteLocation}/categories.xml">
			<filterset>
				<filtersfile file="${buildDirectory}/finalFeaturesVersions.properties"/>
			</filterset>
		</copy>
		<!-- overwrite categories if needed -->
		<copy file="${builder}/${CategoriesXmlFile}" tofile="${UpdateSiteLocation}/categories.xml" overwrite="true" failonerror="false">
			<filterset>
				<filtersfile file="${buildDirectory}/finalFeaturesVersions.properties"/>
			</filterset>
		</copy>

		<antcall target="${ElementsTarget}">
			<param name="genericTargets" value="${builder}/customTargets.xml" />
			<param name="target" value="updateSiteExport" />
		</antcall>

		<zip destfile="${UpdateSiteLocation}/../mylyn-${majorVersion}.${mylynQualifier}-${SiteName}.zip" basedir="${UpdateSiteLocation}" />
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do to test the build results -->
	<!-- ===================================================================== -->
	<target name="test">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do to publish the build results -->
	<!-- ===================================================================== -->
	<target name="publish">
	</target>

	<!-- ===================================================================== -->
	<!-- Default target                                                        -->
	<!-- ===================================================================== -->
	<target name="noDefault">
		<echo message="You must specify a target when invoking this file" />
	</target>

	<target name="updateSiteExport">
		<ant antfile="build.xml" dir="${buildDirectory}/features/${id}/" target="build.update.jar">
			<property name="feature.destination" value="${UpdateSiteLocation}/features" />
			<property name="plugin.destination" value="${UpdateSiteLocation}/plugins" />
		</ant>
	</target>
	
</project>
